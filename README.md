# JChat iOS
## JChat-iOS ç°åœ¨åªå¤„ç† bugï¼Œä¸å†æ·»åŠ æ–°åŠŸèƒ½ï¼Œæ–°åŠŸèƒ½å°†ä¼šåœ¨ [jchat-swift](https://github.com/jpush/jchat-swift) ä¸Šæ›´æ–°ã€‚
### ä»‹ç»

JChat æ˜¯ä¸€ä¸ªèŠå¤© Appã€‚

JChat å…·æœ‰å®Œå¤‡çš„å³æ—¶é€šè®¯åŠŸèƒ½ã€‚ä¸»è¦æœ‰ï¼š

- åŸºæœ¬çš„èŠå¤©ç±»å‹ï¼šæ–‡æœ¬ã€è¯­éŸ³ã€å›¾ç‰‡ï¼›
- å•èŠä¸ç¾¤èŠï¼›
- ç”¨æˆ·å±æ€§ï¼ŒåŒ…æ‹¬å¤´åƒï¼›
- é»‘åå•ï¼›
- å¥½å‹é€šè®¯å½•ï¼›
- [æ¶ˆæ¯åŒæ­¥åŠŸèƒ½](https://github.com/jpush/jchat-ios/releases/tag/v3.1.0)

JChat çš„åŠŸèƒ½åŸºäº JMessage SDK æ¥å¼€å‘ã€‚å®ƒæ˜¯ä¸€ä¸ª JMessage SDK çš„å®Œå¤‡çš„ Demoï¼Œä½†ä¸ä»…ä»…æ˜¯ Demoã€‚æˆ‘ä»¬çš„é¢„æœŸä¸ç›®æ ‡æ˜¯ï¼Œå½“ä½ çš„ä¸šåŠ¡éœ€è¦ä¸€ä¸ªä¼ä¸šçº§çš„èŠå¤© App æ—¶ï¼Œå¯ä»¥åŸºäºè¿™é‡Œæä¾›çš„æºä»£ç ï¼Œæ›´æ¢ Logo ä¸åº”ç”¨åç§°ï¼Œå°±å¯ä»¥ç›´æ¥ç”¨ä¸Šã€‚

JChat å½“å‰æä¾› Android ä¸ iOS ç‰ˆæœ¬ã€‚ç¨åä¹Ÿå°†æä¾› Web ç‰ˆæœ¬ã€‚

- [JChat Android](https://github.com/jpush/jchat-android)

### è¿è¡Œ

æœ¬æºä»£ç é¡¹ç›®è¦ç¼–è¯‘è¿è¡Œè·‘èµ·æ¥ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ã€‚
- å·¥ç¨‹ä½¿ç”¨ cocoapods ç®¡ç†ä¾èµ–å¦‚æœæ²¡æœ‰å®‰è£… pod éœ€è¦å…ˆè¡Œå®‰è£… ğŸ‘‰ [CocoaPods](https://cocoapods.org) 
- æˆåŠŸå®‰è£… cocoapods ååœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼ˆåœ¨ Podfile æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰
```
pod install
```
##### æ‰“å¼€é¡¹ç›®æ–‡ä»¶ JChat.xcworkspace
- å› ä¸ºè¿™æ˜¯ä¸€ä¸ª [CocoaPods](https://cocoapods.org) é¡¹ç›®ã€‚æ‰“å¼€ .xcodeproj é¡¹ç›®ç›®å½•å°†ç¼ºå°‘ä¾èµ–ã€‚

	
##### é…ç½®è¿è¡Œçš„åŸºæœ¬å±æ€§

- appKeyï¼šJPush appKey æ˜¯ JMessage SDK è¿è¡Œçš„åŸºæœ¬å‚æ•°ã€‚è¯·åˆ° [JPush å®˜æ–¹ç½‘ç«™](https://jpush.cn)ç™»å½•æ§åˆ¶å°åˆ›å»ºåº”ç”¨è·å–ã€‚
- bundle_idï¼šè¿™æ˜¯ä¸€ä¸ª iOS åº”ç”¨çš„åŸºæœ¬å±æ€§ã€‚ä½ éœ€è¦ç™»å½•åˆ° Apple å¼€å‘è€…ç½‘ç«™å»åˆ›å»ºåº”ç”¨ã€‚

### JMessage æ–‡æ¡£

- [JMessage iOS é›†æˆæŒ‡å—](http://docs.jpush.io/guideline/jmessage_ios_guide/)
- [JMessage iOS è¯´æ˜](http://docs.jpush.io/client/im_sdk_ios/)
- [JMessage iOS API Docs](http://docs.jpush.io/client/jmessage_ios_appledoc_html/)

### JMessage å‡çº§

JMessage å½“å‰ç‰ˆæœ¬ä¸º 2.0.xã€‚ä¸ä¹‹å‰ 1.0.x ç‰ˆæœ¬æœ‰æ¯”è¾ƒå¤§çš„å˜æ›´ã€‚

å› ä¸ºå˜æ›´å¤ªå¤§ï¼Œæ‰€ä»¥è¿™æ¬¡å˜æ›´æœ‰ç‚¹ä¸å¤Ÿå‹å¥½ï¼Œå¤§éƒ¨åˆ† API æœ‰è°ƒæ•´ï¼ŒåŒ…æ‹¬å¯¹è±¡ç»“æ„ã€‚è¿™ä¼šå¯¼è‡´é›†æˆ JMessage SDK 1.0.x ç‰ˆæœ¬çš„ App åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬æ—¶ï¼Œä¼šç¼–è¯‘ä¸é€šè¿‡ï¼ŒæŸäº› API è°ƒç”¨éœ€è¦è°ƒæ•´ã€‚è°ƒæ•´çš„å…·ä½“æ€è·¯ï¼Œå¯å‚è€ƒæœ¬é¡¹ç›® JChat iOS æºä»£ç ï¼Œä»¥åŠ JMessage iOS ç›¸å…³æ–‡æ¡£ã€‚

## JChat ä»‹ç»

## JChat å·¥ç¨‹ç»“æ„
![å¦‚å›¾](https://github.com/jpush/jchat-ios/blob/master/READMERecource/JChatæµç¨‹å›¾.png)

## JChat ä»£ç ç»“æ„
ä¸»è¦åˆ†ä¸ºäº”ä¸ªåŠŸèƒ½æ¨¡å—ï¼šç”¨æˆ·è¯¦æƒ… (UserInfo)ï¼Œä¼šè¯åˆ—è¡¨ (Conversation List)ï¼Œä¼šè¯ (Conversation) ç™»å½• (Login) å’Œ è®¾ç½® (Setting)ã€‚æ¯ä¸ªåŠŸèƒ½æ¨¡å—æŒ‰ç…§ MVC æ¨¡å¼åˆ’åˆ†ï¼Œéƒ¨åˆ†æ¨¡å—è¿˜æœ‰ä¸€äº› Util ç±»ã€‚

CustomUI
è‡ªå®šä¹‰ View

Category
é€šç”¨ Category

Util
é€šç”¨è¾…åŠ©ç±»

## ä¸»è¦åŠŸèƒ½ç´¢å¼•
### JMessage åˆå§‹åŒ–ä»£ç 
å»ºè®®åœ¨ AppDelegate didFinishLaunchingWithOptions æ–¹å¼åˆå§‹åŒ–ï¼Œå¦‚JChat æ‰€ç¤º
```
- (BOOL)application:(UIApplication *)application
didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
  [self initLogger];

  // init third-party SDK
  [JMessage addDelegate:self withConversation:nil];// è¿™å¥ä»£ç æ”¾åˆ°å‰é¢ç›®çš„æ˜¯ï¼Œåº”ç”¨å¯åŠ¨æ˜¯ä¼šåšæ•°æ®åº“æ˜¯å¦å‡çº§ç›˜ç‚¹ï¼Œå¦‚æœéœ€è¦å‡çº§ï¼Œåˆ™é”å®šæ•°æ®åº“ï¼Œè¿›è¡Œå‡çº§
  
  [JMessage setupJMessage:launchOptions
                   appKey:JMSSAGE_APPKEY
                  channel:CHANNEL apsForProduction:NO
                 category:nil];
  
  [JPUSHService registerForRemoteNotificationTypes:(UIUserNotificationTypeBadge |
                                                    UIUserNotificationTypeSound |
                                                    UIUserNotificationTypeAlert)
                                        categories:nil];
  
  [self registerJPushStatusNotification];
  
  self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
  self.window.rootViewController = [UIViewController new];
  [self.window makeKeyAndVisible];
  [self setupMainTabBar];
  [self setupRootView];
  
  [JCHATFileManager initWithFilePath];//demo åˆå§‹åŒ–å­˜å‚¨è·¯å¾„
  
  return YES;
}

```

æ³¨å†ŒSDK
æ³¨å†ŒAPNS
æˆåŠŸè·å¾—APNS token ä¼ å…¥JPUSHService å¦‚ä¸‹ä»£ç æ‰€ç¤º
```
- (void)application:(UIApplication *)application
didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {
  [JPUSHService registerDeviceToken:deviceToken];
}
```

### æ³¨å†Œ ç™»å½•
é¦–æ¬¡ä½¿ç”¨JMessage éœ€è¦æœ‰JMessage è´¦æˆ·ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ã€‚JChat é¡¹ç›®åœ¨JCHATRegisterViewController ç±»ä¸­æ‰§è¡Œäº†æ³¨å†Œæ“ä½œï¼Œå¹¶ä¸”åœ¨æ³¨å†Œå®Œæˆå›è°ƒæ‰§è¡Œç™»å½•æ“ä½œ(ç™»å½•æ“ä½œä¹Ÿå¯ä»¥ç§»åŠ¨åˆ°å…¶å®ƒåœ°æ–¹è¿›è¡Œï¼Œå…·ä½“çœ‹ç¨‹åºä¸šåŠ¡)ã€‚
```
- (IBAction)registerBtnClick:(id)sender {
  DDLogDebug(@"Action - registerBtnClick");
  if ([self.usernameTextField.text isEqualToString:@""]) {
    [MBProgressHUD showMessage:@"ç”¨æˆ·åä¸èƒ½ä¸ºç©º" view:self.view];
    return;
  }
  
  if ([self.passwordTextField.text isEqualToString:@""]) {
    [MBProgressHUD showMessage:@"å¯†ç ä¸èƒ½ä¸ºç©º" view:self.view];
    return;
  }
  
  [self.usernameTextField resignFirstResponder];
  [self.passwordTextField resignFirstResponder];
  
  NSString *username = self.usernameTextField.text.stringByTrimingWhitespace;
  NSString *password = self.passwordTextField.text.stringByTrimingWhitespace;
  
  if ([self checkValidUsername:username AndPassword:password]) {
    [MBProgressHUD showMessage:@"æ­£åœ¨æ³¨å†Œ" view:self.view];
    [[JCHATTimeOutManager ins] startTimerWithVC:self];
    [JMSGUser registerWithUsername:username
                          password:password
                 completionHandler:^(id resultObject, NSError *error) {
                   [[JCHATTimeOutManager ins] stopTimer];
                   if (error == nil) {
                     [MBProgressHUD hideHUDForView:self.view animated:YES];
                     [MBProgressHUD showMessage:@"æ³¨å†ŒæˆåŠŸ" view:self.view];
                     [[JCHATTimeOutManager ins] startTimerWithVC:self];
                     [JMSGUser loginWithUsername:username
                                        password:password
                               completionHandler:^(id resultObject, NSError *error) {
                                 [[JCHATTimeOutManager ins] stopTimer];
                                 if (error == nil) {
                                   [[NSUserDefaults standardUserDefaults] setObject:username forKey:kuserName];
                                   [[NSUserDefaults standardUserDefaults] setObject:username forKey:klastLoginUserName];
                                   
                                   [MBProgressHUD hideAllHUDsForView:self.view animated:YES];
                                   JCHATSetDetailViewController *detailVC = [[JCHATSetDetailViewController alloc] init];
                                   [self.navigationController pushViewController:detailVC animated:YES];
                                   [MBProgressHUD hideAllHUDsForView:self.view animated:YES];
                                 } else {
                                   DDLogDebug(@"login fail error  %@",error);
                                   NSString *alert = [JCHATStringUtils errorAlert:error];
                                   alert = [JCHATStringUtils errorAlert:error];
                                   [MBProgressHUD hideAllHUDsForView:self.view animated:YES];
                                   [MBProgressHUD showMessage:alert view:self.view];
                                   DDLogError(alert);
                                 }
                               }];
                   } else {
                     NSString *alert = @"æ³¨å†Œå¤±è´¥";
                     alert = [JCHATStringUtils errorAlert:error];
                     [MBProgressHUD hideHUDForView:self.view animated:YES];
                     [MBProgressHUD showMessage:alert view:self.view];
                   }
                 }];
  }
}
```
æ³¨å†Œå®Œæˆä¼šå›è°ƒ handler ï¼Œå¦‚ä¸‹ä»£ç ã€‚å¦‚æœå‡ºç°é”™è¯¯ä¼šè¿”å›çš„error éƒ¨ä½nilï¼Œæ³¨æ„resultOvject ä¸åŒæ¥å£ä¼šè¿”å›ä¸åŒç±»å‹çš„å€¼æˆ–è€…nilï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥å…³æ³¨ [JMessage å®˜æ–¹æ–‡æ¡£](http://docs.jpush.io/client/im_sdk_ios/#summary)
```
typedef void (^JMSGCompletionHandler)(id resultObject, NSError *error);
```

### ä¼šè¯ (Conversation)
ä¼šè¯æ˜¯ä¸€ä¸ªç”¨æˆ·ä¸ç”¨æˆ·ä¹‹é—´èŠå¤©çš„è½½ä½“ï¼Œè¦æœ‰ä¼šè¯ç”¨æˆ·ä¹‹é—´æ‰èƒ½æ”¶å‘æ¶ˆæ¯
è·å¾—ä¼šè¯æœ‰ä¸¤ç§æ–¹å¼ 1. åˆ›å»ºä¼šè¯ 2. è·å–å†å²ä¼šè¯
#### 1.åˆ›å»ºä¼šè¯
å¦‚ä¸‹ä»£ç åˆ†åˆ«åˆ›å»ºäº† å•èŠä¼šè¯ï¼Œå’Œç¾¤èŠä¼šè¯, JChat åœ¨JCHATConversationListViewControllerç±» å®ç°åˆ›å»ºä¼šè¯æ“ä½œ
```

- (void)skipToSingleChatView :(NSNotification *)notification {
  JMSGUser *user = [[notification object] copy];
  __block JCHATConversationViewController *sendMessageCtl =[[JCHATConversationViewController alloc] init];
  __weak typeof(self)weakSelf = self;
  sendMessageCtl.superViewController = self;
  [JMSGConversation createSingleConversationWithUsername:user.username completionHandler:^(id resultObject, NSError *error) {
    __strong __typeof(weakSelf)strongSelf = weakSelf;
    if (error == nil) {
      sendMessageCtl.conversation = resultObject;
      JPIMMAINTHEAD(^{
        sendMessageCtl.hidesBottomBarWhenPushed = YES;
        [strongSelf.navigationController pushViewController:sendMessageCtl animated:YES];
      });
    } else {
      DDLogDebug(@"createSingleConversationWithUsername");
    }
  }];
}
```

#### 2. è·å–å†å²ä¼šè¯
JCHatåœ¨JCHATConversationListViewControllerç±»ä¸­è·å–æ‰€æœ‰å†å²ä¼šè¯çš„å…·ä½“ä»£ç å¦‚ä¸‹
```
- (void)getConversationList {
  [self.addBgView setHidden:YES];
  [JMSGConversation allConversations:^(id resultObject, NSError *error) {
    NSLog(@"the result");
    JPIMMAINTHEAD(^{
      if (error == nil) {
        _conversationArr = [self sortConversation:resultObject];
        _unreadCount = 0;
        for (NSInteger i=0; i < [_conversationArr count]; i++) {
          JMSGConversation *conversation = [_conversationArr objectAtIndex:i];
          _unreadCount = _unreadCount + [conversation.unreadCount integerValue];
        }
        [self saveBadge:_unreadCount];
      } else {
        _conversationArr = nil;
      }
      [self.chatTableView reloadData];
    });
  }];
}
```
#### 3. æ·»åŠ ä»£ç†
è‹¥æƒ³ç›‘å¬conversation çš„æ¶ˆæ¯éœ€è¦æŠŠæŸä¸ªå¯¹è±¡è®¾ä¸ºconversationçš„delegateï¼ˆå¯ä»¥æ˜¯ä»»ä½•å¯¹è±¡ï¼‰ï¼Œæ¯”å¦‚JChat JCHATConversationViewControllerç±»éœ€è¦ç›‘å¬å‘é€å›è°ƒï¼Œå—æ¶ˆæ¯å›è°ƒåˆ™å¿…é¡»å…ˆè®¾ç½®ä»£ç†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹
```
- (void)addDelegate {
  [JMessage addDelegate:self withConversation:self.conversation];
}
```

#### 4. å‘é€æ¶ˆæ¯
JMSGMessage æ˜¯æ¶ˆæ¯çš„å®ä½“ã€‚éœ€è¦è‡ªå·±åˆ›å»ºè¦å‘é€çš„æ¶ˆæ¯ï¼ŒJChat JCHATConversationViewControllerç±»ä¸­å‘é€æ¶ˆæ¯çš„ä»£ç å¦‚ä¸‹
```  
  - (void)prepareTextMessage:(NSString *)text {
  DDLogDebug(@"Action - prepareTextMessage");
  if ([text isEqualToString:@""] || text == nil) {
    return;
  }
  [[JCHATSendMsgManager ins] updateConversation:_conversation withDraft:@""];
  JMSGMessage *message = nil;
  JMSGTextContent *textContent = [[JMSGTextContent alloc] initWithText:text];
  JCHATChatModel *model = [[JCHATChatModel alloc] init];
  
  message = [_conversation createMessageWithContent:textContent];
  [_conversation sendMessage:message];// å‘é€è¯¥æ¡æ¶ˆæ¯
  [self addmessageShowTimeData:message.timestamp];
  [model setChatModelWith:message conversationType:_conversation];
  [self addMessage:model];
}
```

#### 5. æ¥æ”¶æ¶ˆæ¯
å‰é¢å·²ç»è¯´äº†å¯ä»¥ç»™conversation æ·»åŠ å›è°ƒdelegateï¼Œæ”¶åˆ°æ¶ˆæ¯ä¹Ÿæ˜¯é€šè¿‡å›è°ƒå‡½æ•°æ¥è·å–çš„ï¼ŒJChat JCHATConversationViewControllerç±» æ”¶åˆ°æ¶ˆæ¯å›è°ƒæ–¹æ³•å¦‚ä¸‹
```
- (void)onReceiveMessage:(JMSGMessage *)message
                   error:(NSError *)error {
  if (error != nil) {
    JCHATChatModel *model = [[JCHATChatModel alloc] init];
    [model setErrorMessageChatModelWithError:error];
    [self addMessage:model];
    return;
  }
  
  if (![self.conversation isMessageForThisConversation:message]) {
    return;
  }
  
  if (message.contentType == kJMSGContentTypeCustom) {
    return;
  }
  DDLogDebug(@"Event - receiveMessageNotification");
  JPIMMAINTHEAD((^{
    if (!message) {
      DDLogWarn(@"get the nil message .");
      return;
    }
    
    if (_allMessageDic[message.msgId] != nil) {
      DDLogDebug(@"è¯¥æ¡æ¶ˆæ¯å·²åŠ è½½");
      return;
    }
    
    if (message.contentType == kJMSGContentTypeEventNotification) {
      if (((JMSGEventContent *)message.content).eventType == kJMSGEventNotificationRemoveGroupMembers
          && ![((JMSGGroup *)_conversation.target) isMyselfGroupMember]) {
        [self setupNavigation];
      }
    }
    
    if (_conversation.conversationType == kJMSGConversationTypeSingle) {
    } else if (![((JMSGGroup *)_conversation.target).gid isEqualToString:((JMSGGroup *)message.target).gid]){
      return;
    }
    
    JCHATChatModel *model = [[JCHATChatModel alloc] init];
    [model setChatModelWith:message conversationType:_conversation];
    if (message.contentType == kJMSGContentTypeImage) {
      [_imgDataArr addObject:model];
    }
    model.photoIndex = [_imgDataArr count] -1;
    [self addmessageShowTimeData:message.timestamp];
    [self addMessage:model];
  }));
}
```
